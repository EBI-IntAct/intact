<?xml version="1.0" encoding="UTF-8"?>
<!--
     ANT build file for the tulip web service.
     Author: Samuel Kerrien (skerrien@ebi.ac.uk)
-->
<project name="webServiceManager" basedir="." default="prepare">

    <property name="ws.tulip.jar.name" value="tulipService.jar"/>
    <property name="webService.properties.file" value="ws.properties"/>

    <property file="${webService.properties.file}"/>
    <property name="axis.lib.dir" value="${axis.dir}/WEB-INF/lib"/>

    <property name="wsdd.dir" value="wsdd"/>
    <property name="ws.deploy.file" value="${wsdd.dir}/deploy.wsdd"/>
    <property name="ws.undeploy.file" value="${wsdd.dir}/undeploy.wsdd"/>

    <!-- Build working classpath -->
    <path id="project.class.path">
        <fileset dir="${axis.lib.dir}">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <!-- =================================================================== -->

    <!-- Check the configuration and if any errors occured, stop the process -->
    <target name="prepare">

        <echo message=""/>
        <echo message="webService.port = ${webService.port}"/>
        <echo message="axis.dir = ${axis.dir}"/>

        <condition property="webService.axis.notCustomized">
            <contains string="${axis.dir}" substring="AXIS_HOME_PATH"/>
        </condition>
        <antcall target="axis-customized-result"/>

        <available file="${axis.dir}" type="dir" property="axis.present"/>
        <antcall target="axis-present-result"/>

        <condition property="webService.port.notCustomized">
            <contains string="${webService.port}" substring="TOMCAT_PORT"/>
        </condition>
        <antcall target="port-customized-result"/>
    </target>

    <target name="axis-customized-result" if="webService.axis.notCustomized">
        <fail>
            ERROR (property not set):
            You have to edit the following file : ${webService.properties.file}
            and customized axis.dir with the right path.
        </fail>
    </target>

    <target name="port-customized-result" if="webService.port.notCustomized">
        <fail>
            ERROR (property not set):
            You have to edit the following file : ${webService.properties.file}
            and customized webService.port with the right port number.
        </fail>
    </target>

    <target name="axis-present-result" unless="axis.present">
        <fail>
            ERROR (unable to find the axis directory):
            You have to edit the following file : ${webService.properties.file}
            and customized properly axis.dir with the right path.
            Don't put a slash (/) at the end of the path, it wouldn't works.
        </fail>
    </target>

    <!-- =================================================================== -->

    <!-- Copy the web service to the Axis installation dir -->
    <target name="deploy" depends="prepare"
        description="Deploys the web service jar file inside Axis">

        <echo message="Copying web service in Axis..."/>
        <copy file="${ws.tulip.jar.name}" todir="${axis.lib.dir}" overwrite="true"/>

        <echo message="Now you have to restart tomcat before to run the web service"/>
    </target>

    <!-- =================================================================== -->

    <!-- Remove the web service from Axis -->
    <target name="undeploy" depends="prepare" description="Undeploys the web service">

        <antcall target="stop"/>

        <echo message="Remove the service from Axis"/>
        <delete file="${axis.lib.dir}/${ws.tulip.jar.name}"/>
    </target>

    <!-- =================================================================== -->

    <!-- Start the web service by using the modified deployment file. -->
    <target name="start" depends="prepare"
        description="Start the web service by using the deployment file">

        <echo message="Starting the web service on port ${webService.port}" />
        <java classname="org.apache.axis.client.AdminClient" fork="yes">
            <arg line="${ws.deploy.file} -p${webService.port}"/>
            <classpath refid="project.class.path"/>
        </java>
    </target>

    <!-- =================================================================== -->

    <!-- Stop the web service by using the undeployment file -->
    <target name="stop" depends="prepare"
        description="Stop the web service by using the undeployment file">

        <echo message="Stopping the web service on port ${webService.port}" />
        <java classname="org.apache.axis.client.AdminClient" fork="yes">
            <arg line="${ws.undeploy.file} -p${webService.port}"/>
            <classpath refid="project.class.path"/>
        </java>
    </target>

</project>