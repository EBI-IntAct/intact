<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:batch="http://www.springframework.org/schema/batch"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd">


    <context:component-scan base-package="uk.ac.ebi.intact.jami" />

    <import resource="classpath*:/META-INF/psimi-batch-spring.xml"/>
    <import resource="classpath*:/META-INF/intact-jami-spring.xml"/>

    <!-- Complex Reader -->
    <bean id="curatedComplexReader" class="org.springframework.batch.item.database.JpaPagingItemReader" lazy-init="true">
        <!--TODO: Create a proper JAMI HQL query to retrieve all the complexes-->
        <property name="queryString" value="select i from InteractionImpl i join i.annotations as a where a.cvTopic.shortLabel = :curatedComplex order by i.created, i.ac"/>
        <property name="parameterValues">
            <map>
                <entry key="curatedComplex" value="curated-complex"/>
            </map>
        </property>
        <property name="entityManagerFactory" ref="intactEntityManagerFactory"/>
    </bean>

    <!-- Complex Writer -->
    <bean id="curatedComplexWriter" class="uk.ac.ebi.intact.dataexchange.cttv.write.IntactComplexDiseaseWriter">
        <constructor-arg name="filename" value="${target_file}"/>
    </bean>

    <!-- CTTV exporter step -->
    <batch:step id="cttvComplexExporterStep" parent="basicBatchStep">
        <batch:tasklet transaction-manager="jamiTransactionManager">
            <batch:listeners>
                <batch:listener ref="basicChunkLoggerListener" />
            </batch:listeners>

            <batch:chunk reader="curatedComplexReader"
                         writer="curatedComplexWriter"
                         commit-interval="50">
                <batch:streams>
                    <batch:stream ref="curatedComplexReader"/>
                    <batch:stream ref="curatedComplexWriter"/>
                </batch:streams>
            </batch:chunk>
        </batch:tasklet>
    </batch:step>

    <!-- Spring Batch Job -->
    <batch:job id="complexJob" job-repository="basicBatchJobRepository" parent="basicBatchJob">
        <batch:listeners>
            <batch:listener ref="basicJobLoggerListener"/>
        </batch:listeners>

        <batch:step id="cttvComplexExporter" parent="cttvComplexExporterStep"/>
    </batch:job>

</beans>